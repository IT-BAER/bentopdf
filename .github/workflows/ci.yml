# CI/CD workflow for IT-BAER bentopdf fork
# Builds, tests, and creates releases for self-hosted installations
name: CI/CD

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  
jobs:
  # Build and test job
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: TypeScript type check
        run: npx tsc --noEmit
        
      - name: Run tests
        run: npm test
        
      - name: Build application
        run: npm run build
        
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  # Create release on tag push
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
          
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
          
      - name: Create dist archive
        run: |
          cd dist
          zip -r ../bentopdf-${{ steps.version.outputs.version }}.zip .
          cd ..
          tar -czvf bentopdf-${{ steps.version.outputs.version }}.tar.gz -C dist .
          
      - name: Generate changelog excerpt
        id: changelog
        run: |
          # Extract changelog for current version if available
          if [ -f "public/CHANGELOG.md" ]; then
            # Get content between current version header and next version header
            awk '/^## \[?${{ steps.version.outputs.version_number }}\]?/,/^## \[?[0-9]+\.[0-9]+/' public/CHANGELOG.md | head -n -1 > RELEASE_NOTES.md
            if [ ! -s RELEASE_NOTES.md ]; then
              echo "## Release ${{ steps.version.outputs.version }}" > RELEASE_NOTES.md
              echo "" >> RELEASE_NOTES.md
              echo "See [CHANGELOG](public/CHANGELOG.md) for details." >> RELEASE_NOTES.md
            fi
          else
            echo "## Release ${{ steps.version.outputs.version }}" > RELEASE_NOTES.md
          fi
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            bentopdf-${{ steps.version.outputs.version }}.zip
            bentopdf-${{ steps.version.outputs.version }}.tar.gz
            install.sh
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notify on failure (optional)
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build]
    if: failure()
    
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `CI Failed: ${context.workflow} on ${context.ref}`;
            const body = `
            ## CI Workflow Failed
            
            - **Workflow:** ${context.workflow}
            - **Run:** [${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **Branch/Tag:** ${context.ref}
            - **Commit:** ${context.sha}
            - **Actor:** @${context.actor}
            
            Please check the workflow run for details.
            `;
            
            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });
            
            const existingIssue = issues.data.find(issue => issue.title.includes(context.ref));
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ci-failure', 'automated']
              });
            }
